<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OakView + VoltTrading Integration</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #131722;
      color: #d1d4dc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    oakview-chart-layout {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <oakview-chart-layout id="chart" layout="single" symbol="AAPL" theme="dark"></oakview-chart-layout>

  <script type="module">
    /**
     * VoltTrading Integration Example
     *
     * This demonstrates how to use OakView with a custom data provider.
     */

    // Import OakView layout component
    import '../../src/oakview-chart-layout.js';

    // Import custom VoltTrading provider
    import VoltTradingProvider from './volttrading-provider.js';

    // Simple WebSocket wrapper
    class SimpleWebSocket {
      constructor() {
        this.ws = null;
        this.listeners = new Map();
      }

      connect() {
        this.ws = new WebSocket('ws://localhost:8000/ws');

        this.ws.onopen = () => {
          console.log('Connected to VoltTrading backend');
          this.emit('connected', {});
        };

        this.ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          this.emit(message.type, message.data);
        };

        this.ws.onclose = () => {
          console.log('Disconnected from VoltTrading backend');
          this.emit('disconnected', {});
        };
      }

      on(event, callback) {
        if (!this.listeners.has(event)) {
          this.listeners.set(event, []);
        }
        this.listeners.get(event).push(callback);
        return () => {
          const listeners = this.listeners.get(event);
          if (listeners) {
            const index = listeners.indexOf(callback);
            if (index > -1) listeners.splice(index, 1);
          }
        };
      }

      emit(event, data) {
        const listeners = this.listeners.get(event);
        if (listeners) {
          listeners.forEach(callback => callback(data));
        }
      }

      isConnected() {
        return this.ws && this.ws.readyState === WebSocket.OPEN;
      }

      close() {
        if (this.ws) this.ws.close();
      }
    }

    // Simple API wrapper
    class SimpleAPI {
      constructor() {
        this.baseUrl = 'http://localhost:8000';
      }

      async getHistoricalData(symbol, duration, timeframe) {
        const url = `${this.baseUrl}/api/market-data/${symbol}/history?timeframe=${timeframe}&duration=${encodeURIComponent(duration)}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      }

      async subscribeMarketData(symbols) {
        const url = `${this.baseUrl}/api/market-data/subscribe`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(symbols)
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      }

      async unsubscribeMarketData(symbols) {
        const url = `${this.baseUrl}/api/market-data/unsubscribe`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(symbols)
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      }

      async searchSymbols(query) {
        const url = `${this.baseUrl}/api/symbols/search?q=${encodeURIComponent(query)}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      }
    }

    // Per-pane subscriptions: paneId -> { unsubscribe, symbol, interval }
    const paneSubscriptions = new Map();

    // Initialize
    async function init() {
      try {
        console.log('Initializing VoltTrading connection...');

        const wsService = new SimpleWebSocket();
        const apiService = new SimpleAPI();
        const provider = new VoltTradingProvider({ wsService, apiService });

        await provider.initialize();
        console.log('Provider initialized ✓');

        const chartLayout = document.getElementById('chart');
        chartLayout.setDataProvider(provider);
        console.log('Data provider configured ✓');

        // Set up event listeners BEFORE loading data to catch any changes
        // Listen for interval changes (per-pane)
        chartLayout.addEventListener('interval-change', async (e) => {
          const { interval, paneIndex, paneId, symbol } = e.detail;
          if (paneIndex === undefined || paneId === undefined) {
            console.warn('interval-change event missing paneIndex or paneId');
            return;
          }
          console.log(`Interval changed to ${interval} for pane ${paneIndex} (${symbol})`);
          await loadPane(paneIndex, paneId, symbol, interval, provider, chartLayout);
        });

        // Listen for symbol changes (per-pane)
        chartLayout.addEventListener('symbol-change', async (e) => {
          const { symbol, paneIndex, paneId } = e.detail;
          if (paneIndex === undefined || paneId === undefined) {
            console.warn('symbol-change event missing paneIndex or paneId');
            return;
          }
          // Get current interval for this pane
          const sub = paneSubscriptions.get(paneId);
          const interval = sub?.interval || '1D';
          console.log(`Symbol changed to ${symbol} for pane ${paneIndex}`);
          await loadPane(paneIndex, paneId, symbol, interval, provider, chartLayout);
        });

        // Listen for layout changes
        chartLayout.addEventListener('layout-change', async () => {
          console.log('Layout changed, reloading all panes...');
          await new Promise(resolve => setTimeout(resolve, 100));
          await loadAllPanes(provider, chartLayout);
        });

        // Load initial data for all panes (after event listeners are set up)
        await loadAllPanes(provider, chartLayout);

        console.log('\n✨ OakView is now connected to VoltTrading backend');
        console.log('Try changing symbols, timeframes, or layouts using the toolbar!');

      } catch (error) {
        console.error('Initialization failed:', error);
        console.log('\n❌ Make sure the VoltTrading backend is running on http://localhost:8000');
      }
    }

    // Load all panes with their respective settings
    async function loadAllPanes(provider, chartLayout) {
      const chartCount = chartLayout.getChartCount();
      console.log(`Loading ${chartCount} pane(s)...`);

      for (let i = 0; i < chartCount; i++) {
        const chart = chartLayout.getChartAt(i);
        if (chart) {
          const symbol = chart.getAttribute('symbol') || 'AAPL';
          const interval = '1D'; // Default interval
          const paneId = i; // Use index as paneId for now

          await loadPane(i, paneId, symbol, interval, provider, chartLayout);
        }
      }
    }

    // Load a single pane with specific symbol and interval
    async function loadPane(paneIndex, paneId, symbol, interval, provider, chartLayout) {
      try {
        const chart = chartLayout.getChartAt(paneIndex);
        if (!chart) return;

        // Unsubscribe from previous subscription for this pane
        const existingSub = paneSubscriptions.get(paneId);
        if (existingSub?.unsubscribe) {
          existingSub.unsubscribe();
        }

        // Fetch historical data
        const historical = await provider.fetchHistorical(symbol, interval);
        console.log(`[Pane ${paneIndex}] Loaded ${historical.length} bars for ${symbol} @ ${interval}`);

        // Update chart with data
        chart.setData(historical);

        // Subscribe to real-time updates for this pane only
        const unsubscribe = provider.subscribe(symbol, interval, (bar) => {
          // Make sure chart still exists and matches current subscription
          const currentSub = paneSubscriptions.get(paneId);
          if (currentSub && currentSub.symbol === symbol && currentSub.interval === interval) {
            const currentChart = chartLayout.getChartAt(paneIndex);
            if (currentChart) {
              currentChart.updateRealtime(bar);
            }
          }
        });

        // Store subscription info
        paneSubscriptions.set(paneId, { unsubscribe, symbol, interval });

        console.log(`[Pane ${paneIndex}] Subscribed to ${symbol} @ ${interval}`);
      } catch (error) {
        console.error(`[Pane ${paneIndex}] Error loading chart:`, error);
      }
    }

    // Start
    init();
  </script>
</body>
</html>
