"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[55132],{247001:(e,t,i)=>{i.d(t,{trackStudies:()=>r});var s=i(968849),o=i(327734),n=i(776734);function r(e,t){const i=e.metaInfo(),r=!e.isPine()||e.isStandardPine()?i.description:i.scriptIdPart,a=i.productId,l=o.StudyMetaInfo.isScriptStrategy(i),c=window.user&&window.user.pro_plan||"",d=e.model(),h=d.studiesWV().value().length+d.allLineTools().filter(s.isStudyLineTool).length,u=d.chartApi().getStudyCounter();(0,n.getTracker)().then((e=>{e&&e.trackStudiesAnalytics(r,a,t,l,h,u,c)}))}},169958:(e,t,i)=>{i.d(t,{CircularCacheBuffer:()=>n});var s=i(650151);function o(e){const{prevItem:t,nextItem:i}=e;null!==t&&(t.nextItem=i),null!==i&&(i.prevItem=t)}class n{constructor(e=0,t=1.3){this._cache=new Map,this._lastItem=null,this._firstItem=null,this._size=e,this._sizeLimited=e>0,this._capacityFactor=t}set(e,t){const i={key:e,value:t,prevItem:this._lastItem,nextItem:null};null!==this._lastItem&&(this._lastItem.nextItem=i);const s=this._cache.get(e);return void 0!==s&&(o(s),s===this._firstItem&&(this._firstItem=s.nextItem)),this._cache.set(e,i),this._lastItem=i,null===this._firstItem&&(this._firstItem=i),this._sizeLimited&&this._cache.size>this._size*this._capacityFactor&&this._removeExtraItems(),this}has(e){return this._cache.has(e)}get(e){const t=this._cache.get(e);if(void 0===t)return t;if(t===this._firstItem&&(this._firstItem=t.nextItem??t),t!==this._lastItem){o(t);const e=(0,s.ensureNotNull)(this._lastItem);e.nextItem=t,t.prevItem=e,t.nextItem=null,this._lastItem=t}return t.value}clear(){this._cache.clear(),this._firstItem=null,this._lastItem=null}delete(e){const t=this._cache.get(e);return void 0!==t&&(o(t),t===this._lastItem&&(this._lastItem=t.prevItem),t===this._firstItem&&(this._firstItem=t.nextItem)),this._cache.delete(e)}*entries(){if(null!==this._firstItem)for(let e=this._firstItem;null!==e;e=e.nextItem)yield[e.key,e.value]}state(){const e=[];for(const[t,i]of this.entries())e.push([t,i]);return e}restoreState(e){for(const t of e)this.set(t[0],t[1])}_removeExtraItems(){const e=this._cache.size-this._size;let t=(0,s.ensureNotNull)(this._firstItem);for(let i=0;i<e;i+=1)this._cache.delete(t.key),t=(0,s.ensureNotNull)(t.nextItem);t.prevItem=null,this._firstItem=t}}},436465:(e,t,i)=>{i.d(t,{addExclusionArea:()=>P,addExclusionAreaByScope:()=>x,calcTextHorizontalShift:()=>M,clearRect:()=>S,createBoundCanvas:()=>I,createDisconnectedCanvas:()=>p,createDisconnectedCanvasByRenderingInfo:()=>f,disableSelection:()=>y,drawScaled:()=>m,drawWithExclusionAreaByScope:()=>N,fillRect:()=>_,getBindingRenderingInfo:()=>d,getContext2D:()=>h,getPrescaledContext2D:()=>u,measureText:()=>b,tryApplySuggestedCanvasBitmapSize:()=>v});var s=i(327714),o=i(650151),n=i(139832),r=i(204181),a=i(680574),l=i(638456);function c(e){return{horizontalPixelRatio:Math.max(1,e.bitmapSize.width/e.canvasElementClientSize.width),verticalPixelRatio:Math.max(1,e.bitmapSize.height/e.canvasElementClientSize.height)}}function d(e){return{...c(e),bitmapSize:e.bitmapSize,
mediaSize:e.canvasElementClientSize}}function h(e){const t=(0,o.ensureNotNull)(e.getContext("2d"));return t.setTransform(1,0,0,1,0,0),t}function u(e){const t=(0,o.ensureNotNull)(e.getContext("2d")),i=(0,n.getCanvasDevicePixelRatio)(e);return t.setTransform(i,0,0,i,0,0),t}function _(e,t,i,s,o,n){e.save(),e.fillStyle=n,e.fillRect(t,i,s,o),e.restore()}function S(e,t,i,s,o,n){e.save(),e.globalCompositeOperation="copy",e.fillStyle=n,e.fillRect(t,i,s,o),e.restore()}function m(e,t,i,s){e.save(),e.scale(t,i),s(),e.restore()}function p(e,t,i){const s=g(e);return void 0===i&&(i=(0,n.getCanvasDevicePixelRatio)(s)),s.width=t.width*i,s.height=t.height*i,s}function f(e,t){const{bitmapSize:i,mediaSize:s}=t,o=g(e);return o.style.width=`${s.width}px`,o.style.height=`${s.height}px`,o.width=i.width,o.height=i.height,o}function g(e){const t=e.createElement("canvas");return y(t),t}function I(e,t){const i=g((0,o.ensureNotNull)(e.ownerDocument));e.appendChild(i);const n=(0,s.bindCanvasElementBitmapSizeTo)(i,{type:"device-pixel-content-box",transform:(e,t)=>0===e.width||0===e.height?e:{width:Math.max(e.width,t.width),height:Math.max(e.height,t.height)}});return n.resizeCanvasElement(t),n}function v(e){const t=e.suggestedBitmapSize;return null!==t&&t.width>0&&t.height>0&&(e.applySuggestedBitmapSize(),!0)}function M(e,t){return"center"===e.textAlign?0:(0,a.isRtl)()?"start"===e.textAlign||"right"===e.textAlign?t:0:"start"===e.textAlign||"left"===e.textAlign?0:t}function y(e){e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.MozUserSelect="none",e.style.webkitTapHighlightColor="transparent"}function x(e,t){const{context:i,horizontalPixelRatio:s,verticalPixelRatio:o,bitmapSize:n}=e;i.beginPath(),i.rect(0,0,n.width,n.height);for(let e=0;e<t.length;e++){let{x:n,y:r}=t[e];n*=s,r*=o,0!==e?i.lineTo(n,r):i.moveTo(n,r)}i.closePath(),i.clip("evenodd")}function P(e,t,i){x({context:e,...t},i)}function N(e,t,i){e.context.save(),x(e,t),i(),e.context.restore()}let C;function b(e,t,i){return C||function(){const e=document.createElement("canvas");e.width=0,e.height=0,(0,l.isMac)()&&(e.style.display="none",document.body.append(e)),C=(0,o.ensureNotNull)(e.getContext("2d")),C.textBaseline="alphabetic",C.textAlign="center"}(),t&&C.font!==t&&(C.font=t),i?i.getMetrics(C,e):(0,r.getMinTextMetrics)(C.measureText(e))}},139832:(e,t,i)=>{function s(e){return Math.max(1,e.ownerDocument?.defaultView?.devicePixelRatio||1)}i.d(t,{getCanvasDevicePixelRatio:()=>s})},10178:(e,t,i)=>{i.d(t,{DeferredStudies:()=>r});var s=i(197188);const o=[],n=[];class r{constructor(e){this._studies={},this._deferreds={},this._container=e,o.push(e),n.push(this)}add(e,t){this._deferreds[e]&&(this._deferreds[e].resolve(t),delete this._deferreds[e]),this._studies[e]=t}get(e){return this._studies[e]?Promise.resolve(this._studies[e]):(this._deferreds[e]||(this._deferreds[e]=(0,s.createDeferredPromise)()),this._deferreds[e].promise)}delete(e){delete this._studies[e],delete this._deferreds[e]}reset(){const e=o.indexOf(this._container);~e&&(o.splice(e,1),
n.splice(e,1))}static instance(e){const t=o.indexOf(e);return~t?n[t]:new r(e)}static ready(){for(const e of n)if(Object.keys(e._deferreds).length>0)return!1;return!0}}},674377:(e,t,i)=>{var s;i.d(t,{PaneMode:()=>s}),function(e){e[e.Regular=0]="Regular",e[e.Widget=1]="Widget"}(s||(s={}))},399285:(e,t,i)=>{i.d(t,{lineToolsDoNotAffectChartInvalidation:()=>s});const s=!0},496983:(e,t,i)=>{i.d(t,{sourcesAffectState:()=>n});var s=i(453751),o=i(399285);function n(e){return!o.lineToolsDoNotAffectChartInvalidation||e.some((e=>!(0,s.isLineTool)(e)))}},204181:(e,t,i)=>{i.d(t,{TextWidthCache:()=>n,getMinTextMetrics:()=>o});var s=i(169958);function o(e){return{width:e.width,actualBoundingBoxAscent:e.actualBoundingBoxAscent,actualBoundingBoxDescent:e.actualBoundingBoxDescent,fontBoundingBoxAscent:e.fontBoundingBoxAscent,fontBoundingBoxDescent:e.fontBoundingBoxDescent}}class n{constructor(e=150){this._fontStyle="",this._cache=new s.CircularCacheBuffer(e,1.5)}reset(){this._cache.clear()}measureText(e,t,i){let s=t;return i?.mono&&(s=t.replace(/\d/g,"0")),this.getMetrics(e,s).width}yMidCorrection(e,t){const i=this.getMetrics(e,t);return void 0!==i.actualBoundingBoxAscent&&void 0!==i.actualBoundingBoxDescent?(i.actualBoundingBoxAscent-i.actualBoundingBoxDescent)/2:0}getMetrics(e,t){e.font!==this._fontStyle&&(this.reset(),this._fontStyle=e.font);const i=this._cache.get(t);if(void 0!==i)return i;const s=e.textBaseline;e.textBaseline="middle";const n=o(e.measureText(t));return e.textBaseline=s,0===n.width&&t.length||this._cache.set(t,n),n}}},213557:(e,t,i)=>{i.d(t,{ExcludeLineToolsFromGroupUndoCommand:()=>d});var s=i(650151),o=(i(7742),i(444372)),n=i(892323),r=i(536794),a=i(925341),l=i(399285);const c=new n.TranslatedString("exclude line tools from group {group}",o.t(null,void 0,i(99395)));class d extends a.UndoCommand{constructor(e,t,i){super(c.format({group:t.name().value()}),void 0,!l.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))).filter(r.notNull);e.excludeLineTools(t),0===e.lineTools().length&&this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=this._model.lineToolsGroupModel().groupForId(this._groupId);null!==t?t.addLineTools(e):this._model.lineToolsGroupModel().createGroup(e,this._groupName,this._groupId)}}},587399:(e,t,i)=>{i.d(t,{InsertStudyCommand:()=>h});var s=i(650151),o=i(247001),n=i(796114),r=i(400353),a=i(518006),l=i(27681),c=i(925341),d=i(345848);class h extends c.UndoCommand{constructor(e){const{chartModel:t,studyMetaInfo:i,inputs:s,props:o,addAsOverlay:n,parentSources:r,preferredPriceScale:a,allowChangeCurrency:l,allowChangeUnit:c,paneSize:d,targetZOrder:h,studyId:u,targetScaleMode:_,undoText:S}=e;super(S??null),this._paneState=null,this._studyInserResult=null,
this._additionalStudiesInsertResults=[],this._chartModel=t,this._studyMetaInfo=i,this._props=o,this._addAsOverlay=n,this._parentIds=r.map((e=>e.id())),this._inputs=s,this._targetZOrder=h,this._preferredPriceScale=a,this._allowChangeCurrency=l,this._allowChangeUnit=c,this._paneSize=d,this._studyId=u??null,this._targetScaleMode=_??null}redo(){const e=this._parentIds.map((e=>this._chartModel.dataSourceForId(e)));this._studyInserResult=this._chartModel.insertStudyWithParams(this._studyMetaInfo,this._inputs,this._targetZOrder,this._props,this._addAsOverlay,e,this._preferredPriceScale,this._allowChangeCurrency,this._allowChangeUnit,this._paneSize,this._targetScaleMode??void 0,this._studyId??void 0),this._studyInserResult.study.then((e=>{if((0,l.isSymbolSource)(e)){null!==e.symbolInfo()?this._createCopiesOfExistingFundamentalsForNewStock(e):e.symbolResolved().subscribe(this,(()=>this._createCopiesOfExistingFundamentalsForNewStock(e)),!0)}else(0,a.isFundamentalStudy)(e)&&this._createCopiesOfNewFundamentalForAllStocks(e);if(this._studyId=e.id(),e.childStudyByRebind().subscribe(null,(()=>(0,d.trackEvent)("SOS","Apply SOS","Rebind SOS"))),(0,o.trackStudies)(e,"add"),this._chartModel.setShouldBeSavedEvenIfHidden(!0),null!==this._paneState){(0,s.ensureNotNull)(this._chartModel.paneForSource(e)).restoreState({state:this._paneState,withData:!1,version:this._chartModel.version()}),this._paneState=null}}))}undo(){const e=(0,s.ensureNotNull)(this._studyInserResult),t=e.entityId();let i=null,o=null;if(null!==t){i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(t));const n=e.originalScaleMode();null!==n&&i.priceScale()?.setMode(n),(0,l.isSymbolSource)(i)&&i.symbolResolved().unsubscribeAll(this),o=(0,s.ensureNotNull)(this._chartModel.paneForSource(i)).state()}else e.cancel();this._studyInserResult?.cancel();for(const e of this._additionalStudiesInsertResults){const t=e.entityId();null!==t?this._chartModel.removeSource((0,s.ensureNotNull)(this._chartModel.dataSourceForId(t))):e.cancel()}this._additionalStudiesInsertResults=[],null!==i&&this._chartModel.removeSource(i)&&(this._paneState=o)}insertedStudy(){return(0,s.ensureNotNull)(this._studyInserResult)}_createCopiesOfNewFundamentalForAllStocks(e){let t=(0,s.ensureNotNull)((0,r.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();e.isStarted()||(t-=1);const i=this._studyMetaInfo.symbolInputId(),o=this._chartModel.symbolSources();for(const r of o){if(t<=0)break;if(!r.isVisible()||r===e.symbolSource())continue;const o=r.symbolInfo();if(null!==o&&(0,n.isStockSymbol)(o.type,o.typespecs)){const e={};e[(0,s.ensureNotNull)(i)]=r.symbol();const o=this._chartModel.insertStudyWithParams(this._studyMetaInfo,e,null,this._props,!1);this._additionalStudiesInsertResults.push(o),t-=1}}}_createCopiesOfExistingFundamentalsForNewStock(e){let t=(0,s.ensureNotNull)((0,r.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();const i=e.symbolInfo();if(null!==i&&(0,n.isStockSymbol)(i.type,i.typespecs)){
const i=new Set,o=this._chartModel.allStudies(!0).filter((e=>(0,a.isFundamentalStudy)(e)&&e.isVisible()));for(const n of o){if(t<=0)break;const o=n.metaInfo();if(!i.has(o.fullId)){const n={};n[(0,s.ensureNotNull)(o.symbolInputId())]=e.symbol();const r=this._chartModel.insertStudyWithParams(o,n,null,this._props,!1);this._additionalStudiesInsertResults.push(r),t-=1,i.add(o.fullId)}}}}}},639399:(e,t,i)=>{i.d(t,{LineToolSynchronizeUndoCommand:()=>o});var s=i(925341);class o extends s.UndoCommand{constructor(e,t,i,s=!0){super(t,i,s),this._invalidateViaSync=!1,this._chartModel=e,this._invalidateViaSync=e.lineToolsSynchronizer().invalidateViaSync()}redo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSynchronizationInLayoutAction((async()=>this._redo())):this._redo()}undo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSynchronizationInLayoutAction((async()=>this._undo())):this._undo()}}},524966:(e,t,i)=>{i.d(t,{MergeDownUndoCommand:()=>l,MergeToTargetPane:()=>c,MergeUpUndoCommand:()=>a});var s=i(650151),o=i(674377),n=i(572575);class r extends n.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,i),this._restorePane=!1,this._keepZOrder=s??!1,this._initialZOrder=t.zorder()}redo(){const e=this._chartModel.panes().length,t=this._chartModel.panes()[this._targetPaneIndex()],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),o=(0,s.ensureNotNull)(this._chartModel.paneForSource(i)),n=this._chartModel.children(i,!0,!0);o.bulkActionMacro((()=>{n.forEach((e=>this._chartModel.detachSource(e))),this._restorePane=this._chartModel.detachSource(i)}));const r="overlay"===this._initialPriceScalePosition?this._initialPriceScalePosition:void 0,a=t.findSuitableScale(i,void 0,r),l=0===a.dataSources().length;if(t.bulkActionMacro((()=>{t.addDataSource(i,a,this._keepZOrder),n.forEach((e=>t.addDataSource(e,a,this._keepZOrder)))})),i===this._chartModel.mainSeries()){const e=t.priceScalePosition(a);t.movePriceScale(a,e,0)}if(l){const e=(0,s.ensureNotNull)(i.priceScale());e.restoreState(this._newPriceScaleState(t.isOverlay(i))),e.setHeight(t.height())}this._chartModel.fullUpdate(),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){let e;e=this._restorePane?this._chartModel.createPane(this._initialPaneIndex):this._chartModel.panes()[this._initialPaneIndex];const t=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),i=(0,s.ensureNotNull)(this._chartModel.paneForSource(t)),o=this._chartModel.children(t,!0,!0);i.bulkActionMacro((()=>{o.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(t)}));let n=e.getPriceScaleById(this._initialPriceScaleId);null===n&&(n=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),e.bulkActionMacro((()=>{t.setZorder(this._initialZOrder),e.addDataSource(t,n,!0),o.forEach((t=>e.addDataSource(t,n,!1)))}));const r=(0,s.ensureNotNull)(t.priceScale());r.restoreState(this._originalPriceScaleState()),r.setHeight(e.height()),
this._chartModel.fullUpdate()}}class a extends r{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){const e=this._chartModel.panes();for(let t=this._initialPaneIndex-1;t>=0;t--)if(e[t].mode()===o.PaneMode.Regular)return t;throw new Error("No regular pane found above for merging")}}class l extends r{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){const e=this._chartModel.panes();for(let t=this._initialPaneIndex+1;t<e.length;t++)if(e[t].mode()===o.PaneMode.Regular)return t;throw new Error("No regular pane found below for merging")}}class c extends r{constructor(e,t,i,s,o){super(e,t,s,o),this._targetPane=i}_targetPaneIndex(){return this._targetPane}}},572575:(e,t,i)=>{i.d(t,{MoveSourceUndoCommand:()=>n});var s=i(650151),o=i(925341);class n extends o.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._sourceId=t.id();const o=(0,s.ensureNotNull)(t.priceScale());this._initialPriceScaleId=o.id(),this._initialPriceScaleState=(0,s.ensureNotNull)(t.priceScale()).state();const n=(0,s.ensureNotNull)(e.paneForSource(t));this._initialPriceScalePosition=n.priceScalePosition(o),this._initialPriceScaleIndex=n.priceScaleIndex(o,this._initialPriceScalePosition),this._initialPaneIndex=e.panes().indexOf(n)}_newPriceScaleState(e){const t={...this._initialPriceScaleState};return delete t.m_isLockScale,delete t.id,delete t.m_topMargin,delete t.m_bottomMargin,delete t.hasCalculatedPriceRange,t}_originalPriceScaleState(){return this._initialPriceScaleState}}},291793:(e,t,i)=>{i.d(t,{MoveToExistingPriceScaleUndoCommand:()=>a,MoveToNewPriceScaleUndoCommand:()=>r});var s=i(650151),o=i(572575);class n extends o.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,s),this._sourcePaneRemoved=!1,this._targetPaneIndex=e.panes().indexOf(i)}redo(){const e=this._chartModel.panes()[this._initialPaneIndex],t=this._chartModel.panes()[this._targetPaneIndex],i=e!==t,o=this._targetPriceScale(t),n=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),r=this._chartModel.children(n,!0,!0);for(const e of r)i?(this._chartModel.detachSource(e),t.addDataSource(e,o,!1)):t.move(e,o);i?(this._sourcePaneRemoved=this._chartModel.detachSource(n),t.addDataSource(n,o,!1)):t.move(n,o);const a=t.priceScalePosition(o);t.movePriceScale(o,a,this._targetPriceScaleIndex(n)),this._chartModel.fullUpdate()}undo(){this._sourcePaneRemoved&&this._chartModel.createPane(this._initialPaneIndex);const e=this._chartModel.panes()[this._initialPaneIndex],t=e!==this._chartModel.panes()[this._targetPaneIndex],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId));let o=e.getPriceScaleById(this._initialPriceScaleId);null===o&&(o=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex));const n=this._chartModel.children(i,!0,!0);for(const i of n)t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);const r=(0,s.ensureNotNull)(i.priceScale());r.restoreState(this._originalPriceScaleState()),r.setHeight(e.height()),
this._chartModel.fullUpdate()}}class r extends n{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScalePosition=s}_targetPriceScale(e){const t=e.createPriceScaleAtPosition(this._targetPriceScalePosition);return t.restoreState(this._newPriceScaleState("overlay"===this._targetPriceScalePosition)),t.setHeight(e.height()),t}_targetPriceScaleIndex(e){return e===this._chartModel.mainSeries()?0:void 0}}class a extends n{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScaleId=s.id()}_targetPriceScale(e){return(0,s.ensureNotNull)(e.getPriceScaleById(this._targetPriceScaleId))}_targetPriceScaleIndex(e){}}},542366:(e,t,i)=>{i.d(t,{RemoveSourcesUndoCommand:()=>g});var s=i(650151),o=i(735566),n=i(444372),r=i(892323),a=i(247001),l=i(639399),c=i(712509),d=i(518006),h=i(399285),u=i(213557);class _ extends l.LineToolSynchronizeUndoCommand{constructor({chartModel:e,title:t,lineDataSourceIds:i}){super(e,t,void 0,!h.lineToolsDoNotAffectChartInvalidation),this._excludeLineToolsFromGroupUndoCommands=[],this._undoState=[],this._lineDataSourceIds=i}_redo(){const e=this._lineDataSourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._groupLineToolsByGroups(e).forEach(((e,t)=>{const i=new u.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,t,e);i.redo(),this._excludeLineToolsFromGroupUndoCommands.push(i)})),e.forEach((e=>{this._undoState.push({state:e.state(!1),paneIndex:this._chartModel.panes().indexOf((0,s.ensureNotNull)(this._chartModel.paneForSource(e))),sharingMode:e.sharingMode().value()}),this._chartModel.removeSource(e)}))}_undo(){for(let e=this._undoState.shift();e;e=this._undoState.shift())this._chartModel.restoreSource(!1,e.paneIndex,null,e.state,null)?.share(e.sharingMode);this._excludeLineToolsFromGroupUndoCommands.forEach((e=>e.undo()))}_groupLineToolsByGroups(e){const t=this._chartModel.lineToolsGroupModel();return e.reduce(((e,i)=>{const s=t.groupForLineTool(i);if(null!==s){const t=e.get(s)||[];t.push(i),e.set(s,t)}return e}),new Map)}}var S=i(848933),m=i(496983);const p=(0,o.getLogger)("Chart.RemoveSourcesUndoCommand"),f=new r.TranslatedString("remove line data sources",n.t(null,void 0,i(838199)));class g extends l.LineToolSynchronizeUndoCommand{constructor(e,t,i){super(e,i,void 0,(0,m.sourcesAffectState)(t)),this._removeLineDataSourcesUndoCommand=null,this._initialPriceScaleMode=null;const[o,n]=(0,c.sourcesAndLineTools)(e,t);this._sourceIds=o,this._lineDataSourceIds=n,this._sourceStates=[],this._paneIndexes=[],this._priceScalePositionIds=[],this._paneStates=[],this._restorePanes=[];const r=t[0];1===t.length&&(0,d.isStudy)(r)&&(this._initialPriceScaleMode=(0,s.ensureNotNull)(r.priceScale()).mode())}removedIds(){return[...this._sourceIds,...this._lineDataSourceIds]}_redo(){const e=this._chartModel.panes().length,t=this._sourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._sourceStates=t.map((e=>{const t=e.state(!1);return null===t&&(0,d.isStudyStub)(e)?e.getDescriptor():t}));const i=t.map((e=>(0,s.ensureNotNull)(this._chartModel.paneForSource(e))))
;this._paneIndexes=i.map((e=>this._chartModel.panes().indexOf(e))),this._lineDataSourceIds.length>0&&(this._removeLineDataSourcesUndoCommand=new _({title:f,chartModel:this._chartModel,lineDataSourceIds:this._lineDataSourceIds}),this._removeLineDataSourcesUndoCommand.redo()),this._priceScalePositionIds=t.map(((e,t)=>{const s=e.priceScale();if(null===s)return null;const o=i[t].priceScalePosition(s);return{id:s.id(),position:o,priceScaleIndex:i[t].priceScaleIndex(s,o)}}));const o=new Set;t.forEach(((e,t)=>{o.add(this._paneIndexes[t])})),this._paneStates=t.map(((e,t)=>{const s=this._paneIndexes[t];return o.has(s)?i[t].state({includeSources:!1,withData:!0}):null})),this._restorePanes=t.map((e=>this._chartModel.removeSource(e))),t.forEach((e=>{(0,d.isStudy)(e)&&(0,a.trackStudies)(e,"remove")})),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}_undo(){const e=[];for(let t=this._sourceStates.length-1;t>=0;t--){const i=this._sourceStates[t];if(null!==i){let s=null;s=(0,S.isStudyStubDescriptor)(i)?this._chartModel.restoreStudyStub(i):this._chartModel.restoreSource(this._restorePanes[t],this._paneIndexes[t],this._paneStates[t],i,this._priceScalePositionIds[t]),s&&e.push(s)}}e.some(((t,i)=>t.id()!==this._sourceIds[e.length-i-1]))&&p.logError("Source was restored improperly - source ids does not match"),null!==this._initialPriceScaleMode&&(0,s.ensureNotNull)(e[0].priceScale()).setMode(this._initialPriceScaleMode),this._removeLineDataSourcesUndoCommand&&this._removeLineDataSourcesUndoCommand.undo()}}},712509:(e,t,i)=>{i.d(t,{closeSourcesSet:()=>r,removeAllSourcesWithDependencies:()=>l,sourcesAndLineTools:()=>a});var s=i(536794),o=i(453751);function n(e,t,i){let s=[];const o=e.children(t,!1,i);for(let t=0;t<o.length;t++)s=s.concat(n(e,o[t],i));return s.push(t),s}function r(e,t,i){const s=new Set,o=t=>{e.children(t,!1,i).forEach((e=>{s.has(e)||(s.add(e),o(e))}))};return t.forEach(o),t.filter((e=>!s.has(e))).map((t=>n(e,t,i))).reduce(((e,t)=>e.concat(t)),[])}function a(e,t){return r(e,t,!0).reduce(((e,t)=>((0,o.isLineTool)(t)?e[1].push(t.id()):e[0].push(t.id()),e)),[[],[]])}function l(e,t){a(e,t).reverse().forEach((t=>{t.map((t=>e.dataSourceForId(t))).filter(s.notNull).forEach((t=>{(0,o.isLineTool)(t)&&e.lineToolsGroupModel().removeLineTools([t]),e.removeSource(t)}))}))}},308950:(e,t,i)=>{var s;i.d(t,{AlertEditorAbortReason:()=>s}),function(e){e.AlertIsInvalid="alert-is-invalid",e.AlertsMaintenance="alerts-maintenance",e.ChartModelNotFound="chart-model-not-found",e.IsAlreadyPresent="is-already-present",e.MainSeriesIsATR="main-series-is-atr",e.MainSeriesIsPercentageLTP="main-series-is-percentage-ltp",e.MainSeriesIsInReplay="main-series-is-in-replay",e.MainSeriesIsOffline="main-series-is-offline",e.SourceIsDangerous="source-is-dangerous",e.SymbolInfoTimeout="symbol-info-timeout",e.SymbolIsInvalid="symbol-is-invalid",e.SymbolCurrencyConverted="symbol-currency-converted",e.SymbolUnitConverted="symbol-unit-converted",e.SymbolCurrencyAndUnitConverted="symbol-currency-and-unit-converted",
e.SymbolIsEconomics="symbol-is-economics",e.UnsupportedResolution="unsupported-resolution",e.ManualAbort="manual-abort",e.MisleadingPriceScale="misleading-price-scale",e.ResolutionIsTicks="resolution-is-ticks"}(s||(s={}))}}]);