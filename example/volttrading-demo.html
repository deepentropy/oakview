<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OakView + VoltTrading Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #131722;
            overflow: hidden;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif;
        }

        oakview-chart-layout {
            width: 100%;
            height: 100vh;
        }

        .status-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1E222D;
            padding: 8px 12px;
            border-radius: 4px;
            color: #787B86;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #787B86;
        }

        .status-indicator.connected {
            background: #26a69a;
        }

        .status-indicator.disconnected {
            background: #ef5350;
        }
    </style>
</head>
<body>
    <!-- Status indicator -->
    <div class="status-bar">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Chart layout -->
    <oakview-chart-layout
        id="chartLayout"
        layout="single"
        symbol="AAPL"
        theme="dark">
    </oakview-chart-layout>

    <script type="module">
        // Import OakView components and VoltTrading provider
        import '../src/oakview-chart-layout.js';
        import { VoltTradingProvider } from '../src/data-providers/index.js';

        // Note: In a real implementation, you would import these from your volttrading project
        // For this demo, we'll create mock services that match the volttrading API

        // Mock WebSocket Service (replace with real volttrading wsService)
        class MockWebSocketService {
            constructor() {
                this.listeners = new Map();
                this.connected = false;
            }

            connect() {
                console.log('Mock WebSocket: Connecting...');
                setTimeout(() => {
                    this.connected = true;
                    this.emit('connected', {});
                    console.log('Mock WebSocket: Connected');
                }, 1000);
            }

            disconnect() {
                this.connected = false;
                this.emit('disconnected', {});
            }

            isConnected() {
                return this.connected;
            }

            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, new Set());
                }
                this.listeners.get(event).add(callback);

                // Return unsubscribe function
                return () => {
                    const callbacks = this.listeners.get(event);
                    if (callbacks) {
                        callbacks.delete(callback);
                    }
                };
            }

            emit(event, data) {
                const callbacks = this.listeners.get(event);
                if (callbacks) {
                    callbacks.forEach(callback => callback(data));
                }
            }

            // Simulate sending quotes
            simulateQuote(symbol, price) {
                this.emit('quote', {
                    symbol,
                    quote: {
                        symbol,
                        last: price,
                        bid: price - 0.01,
                        ask: price + 0.01,
                        volume: Math.floor(Math.random() * 1000000),
                        timestamp: new Date().toISOString()
                    }
                });
            }
        }

        // Mock API Service (replace with real volttrading apiService)
        class MockAPIService {
            constructor() {
                this.subscribedSymbols = new Set();
            }

            async subscribeMarketData(symbols) {
                console.log('Mock API: Subscribe to', symbols);
                symbols.forEach(s => this.subscribedSymbols.add(s));
                return { success: true };
            }

            async unsubscribeMarketData(symbols) {
                console.log('Mock API: Unsubscribe from', symbols);
                symbols.forEach(s => this.subscribedSymbols.delete(s));
                return { success: true };
            }

            async getHistoricalData(symbol, duration = '1 Y', timeframe = '1D') {
                console.log(`Mock API: Fetching historical data for ${symbol} (${timeframe}, ${duration})`);

                // Generate mock historical data
                const bars = [];
                const now = Math.floor(Date.now() / 1000);
                const daySeconds = 86400;
                let basePrice = 150 + Math.random() * 50;

                // Generate 365 days of data
                for (let i = 365; i > 0; i--) {
                    const timestamp = new Date((now - (i * daySeconds)) * 1000).toISOString();
                    const change = (Math.random() - 0.5) * 10;
                    const open = basePrice;
                    const close = basePrice + change;
                    const high = Math.max(open, close) + Math.random() * 5;
                    const low = Math.min(open, close) - Math.random() * 5;

                    bars.push({
                        timestamp: timestamp.replace('Z', ''),
                        open,
                        high,
                        low,
                        close,
                        volume: Math.floor(Math.random() * 10000000)
                    });

                    basePrice = close;
                }

                return { bars };
            }

            async searchSymbols(query) {
                console.log('Mock API: Searching symbols:', query);

                // Mock search results
                const allSymbols = [
                    { symbol: 'AAPL', description: 'Apple Inc.', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'MSFT', description: 'Microsoft Corporation', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'GOOGL', description: 'Alphabet Inc.', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'AMZN', description: 'Amazon.com, Inc.', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'TSLA', description: 'Tesla, Inc.', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'NVDA', description: 'NVIDIA Corporation', primaryExchange: 'NASDAQ', secType: 'stock' },
                    { symbol: 'META', description: 'Meta Platforms, Inc.', primaryExchange: 'NASDAQ', secType: 'stock' },
                ];

                return allSymbols.filter(s =>
                    s.symbol.toLowerCase().includes(query.toLowerCase()) ||
                    s.description.toLowerCase().includes(query.toLowerCase())
                );
            }
        }

        // Initialize mock services
        const wsService = new MockWebSocketService();
        const apiService = new MockAPIService();

        // Create VoltTrading provider
        const provider = new VoltTradingProvider({
            wsService,
            apiService
        });

        // Get chart layout
        const chartLayout = document.getElementById('chartLayout');

        // Status UI
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        async function initialize() {
            try {
                // Initialize provider (connects WebSocket)
                await provider.initialize();

                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected';

                // Set provider on layout
                chartLayout.setDataProvider(provider);

                // Load initial symbol
                const symbol = chartLayout.getAttribute('symbol') || 'AAPL';
                await loadSymbol(symbol, '1D');

                // Simulate real-time updates
                simulateRealTimeUpdates(symbol);

                console.log('âœ… OakView + VoltTrading initialized successfully');
            } catch (error) {
                console.error('Failed to initialize:', error);
                statusIndicator.classList.add('disconnected');
                statusText.textContent = 'Connection failed';
            }
        }

        // Load symbol data
        async function loadSymbol(symbol, interval = '1D') {
            console.log(`Loading symbol: ${symbol} (${interval})`);

            try {
                // Fetch historical data
                const historical = await provider.fetchHistorical(symbol, interval);
                console.log(`Loaded ${historical.length} historical bars`);

                // Set data on chart
                const chart = chartLayout.getChartAt(0);
                if (chart) {
                    chart.setData(historical);
                }

                // Subscribe to real-time updates
                const unsubscribe = provider.subscribe(symbol, interval, (data) => {
                    if (chart) {
                        chart.updateRealtime(data);
                    }
                });

                // Store unsubscribe function for cleanup
                window._currentSubscription = unsubscribe;
            } catch (error) {
                console.error('Failed to load symbol:', error);
            }
        }

        // Simulate real-time price updates
        function simulateRealTimeUpdates(symbol) {
            let currentPrice = 150 + Math.random() * 50;

            setInterval(() => {
                // Random walk
                currentPrice += (Math.random() - 0.5) * 2;
                wsService.simulateQuote(symbol, currentPrice);
            }, 2000); // Update every 2 seconds
        }

        // Listen for symbol changes
        chartLayout.addEventListener('symbol-change', async (e) => {
            console.log('Symbol changed:', e.detail);

            // Unsubscribe from previous symbol
            if (window._currentSubscription) {
                window._currentSubscription();
            }

            // Load new symbol
            await loadSymbol(e.detail.symbol, e.detail.interval || '1D');

            // Update simulation
            simulateRealTimeUpdates(e.detail.symbol);
        });

        // Listen for interval changes
        chartLayout.addEventListener('interval-change', async (e) => {
            console.log('Interval changed:', e.detail);

            const symbol = chartLayout.getAttribute('symbol');

            // Unsubscribe from previous
            if (window._currentSubscription) {
                window._currentSubscription();
            }

            // Reload with new interval
            await loadSymbol(symbol, e.detail.interval);
        });

        // Start the app
        initialize();
    </script>
</body>
</html>
